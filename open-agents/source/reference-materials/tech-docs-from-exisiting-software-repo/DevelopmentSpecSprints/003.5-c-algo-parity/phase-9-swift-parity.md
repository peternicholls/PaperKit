# Phase 9: Swift Wrapper Parity Testing

**Purpose**: Validate that the Swift wrapper accurately passes data between Swift and the C core without introducing deviations, ensuring the public API is a faithful interface to the canonical C engine.

**Status**: Planning  
**Branch**: 004-incremental-creation  
**Depends On**: Phase 1-8 (C Algorithm Parity complete)

---

## Overview

Phase 9 replicates the C parity testing methodology but focuses on the Swift wrapper layer. We verify that:

1. **Data accuracy**: Swift inputs are correctly marshaled to C
2. **Output fidelity**: C outputs are accurately unmarshaled to Swift types
3. **Numerical equivalence**: Swift palette outputs match known C reference outputs with zero deviation
4. **API correctness**: The public Swift API exposes the C core faithfully without hidden transformations

### Architecture

```
Swift API → C Core → Parity Comparison
     ↓
  Test Suite
     ↓
  Report (same format as C parity)
```

The Swift wrapper sits between user code and the C core. Our tests ensure this boundary is transparent:

```
Input → [Swift Wrapper] → C Core → Normalize → Compare vs. C Reference → Report
```

The location of the Swift module wrapper code we are testing is `Sources/ColorJourney/*`. **We are testing the existing wrapper layer as-is; no modifications to the C core (Sources/CColorJourney/) are required.**

---

## Test Strategy

### Corpus Reuse
We reuse the exact same corpus as Phase 1-8:
- `specs/003.5-c-algo-parity/corpus/default.json` (3 baseline cases)
- `specs/003.5-c-algo-parity/corpus/edge-cases.json` (4 boundary cases)

### Execution Path

1. **Parse corpus** (JSON → Swift structures)
2. **Create Swift ColorJourney** with corpus parameters
3. **Generate palette** using Swift API
4. **Normalize output** to OKLab (same as C parity)
5. **Compare against C reference** outputs from Phase 8 artifacts
6. **Compute deltas** (ΔE, per-channel) using identical metrics
7. **Generate report** in same JSON format for statistical consistency

### Tolerances

**Identical to Phase 1-8**:
- Absolute: L/a/b = 1e-4, ΔE = 0.5
- Relative: L/a/b = 1e-3
- Pass gate: 95% of cases must pass

**Rationale**: Swift→C should introduce zero deviation. If tolerance differences emerge, they indicate bugs in the wrapper or type conversion logic.

---

## Test Components

### 1. Unit Tests (Swift)

**Location**: `Tests/ColorJourneyTests/ParityTests/`

**Test Classes**:

- **ParityInputMarshalingTests**
  - Verify corpus JSON parses to ColorJourneyConfig
  - Confirm OKLab anchors convert to RGB and back without loss
  - Validate all parameters map correctly (lightness, chroma, contrast, etc.)

- **ParityOutputNormalizationTests**
  - Verify palette output normalizes to OKLab consistently
  - Confirm ΔE calculations match C implementation
  - Validate per-channel delta computation

- **ParityComparisonTests**
  - Test tolerance application (absolute, relative)
  - Verify pass/fail logic
  - Validate statistical calculations (mean, stddev, percentiles)

### 2. Integration Tests (Swift + C)

**Location**: `specs/003.5-c-algo-parity/tools/swift-parity-runner/`

**Components**:

- **Swift JSON Runner** (`SwiftParityRunner.swift`)
  - Accepts same corpus JSON input as C runner
  - Creates `ColorJourney` instances per case
  - Outputs palette JSON (same format as C runner)

- **Comparison Bridge** (`ComparisonBridge.swift`)
  - Links Swift output to C reference outputs
  - Normalizes both to OKLab
  - Computes deltas using identical math

- **Report Generator** (`ReportGenerator.swift`)
  - Produces JSON matching C parity report schema
  - Includes provenance (Swift version, target SDK)
  - References artifacts exactly like C tests

### 3. End-to-End Tests

**Location**: `specs/003.5-c-algo-parity/` (Phase 9 tasks)

**Execution**:

```bash
# Build Swift runner
swift build -c release

# Run against corpus
./.build/release/swift-parity-runner \
  --corpus corpus/default.json \
  --c-reference artifacts/full-run-default/report.json \
  --artifacts artifacts/swift-parity-default/
```

**Output**: JSON report identical in structure to C parity reports

---

## Data Models

### Input (Reused from Phase 1-8)

Corpus structure unchanged:
```json
{
  "corpusVersion": "v20251212.1",
  "cases": [
    {
      "id": "baseline-wheel",
      "anchors": [...],
      "config": {
        "count": 12,
        "lightness": 0.65,
        "chroma": 0.15
      },
      "seed": 42
    }
  ]
}
```

### Output (Swift Palette)

Generated by Swift API:
```json
{
  "caseId": "baseline-wheel",
  "colors": [
    {
      "index": 0,
      "oklab": {"l": 0.706, "a": 0.045, "b": 0.014},
      "rgb": {"r": 0.8, "g": 0.2, "b": 0.1},
      "hex": "#CC3319"
    }
  ]
}
```

### Comparison Result (Swift vs C Reference)

```json
{
  "caseId": "baseline-wheel",
  "swiftColor": {
    "oklab": {"l": 0.706137, "a": 0.045551, "b": 0.014190}
  },
  "cReference": {
    "oklab": {"l": 0.706137, "a": 0.045551, "b": 0.014190}
  },
  "delta": {
    "l": 0.0,
    "a": 0.0,
    "b": 0.0,
    "deltaE": 0.0
  },
  "status": "pass"
}
```

### Report (Same Schema as C Parity)

```json
{
  "runId": "swift-parity-20251212-001",
  "phase": 9,
  "description": "Swift wrapper parity vs C reference outputs",
  "corpusVersion": "v20251212.1",
  "swiftVersion": "5.9",
  "targetSDK": "iOS 13+",
  "platform": "macOS",
  "summary": {
    "totalCases": 7,
    "passed": 7,
    "failed": 0,
    "passRate": 1.0,
    "deltaE": {
      "mean": 0.0,
      "stddev": 0.0,
      "p50": 0.0,
      "p95": 0.0,
      "p99": 0.0,
      "max": 0.0
    }
  },
  "cases": [...]
}
```

---

## Tasks

### Phase 9a: Swift Unit Tests (Marshalig & Normalization)

- [ ] **T051** Implement JSON corpus parser in Swift (Codable structures)
- [ ] **T052** Add unit tests for OKLab↔RGB conversions
- [ ] **T053** Add unit tests for anchor color loading from corpus
- [ ] **T054** Add unit tests for parameter mapping (lightness, chroma, etc.)
- [ ] **T055** Add unit tests for output normalization (palette → OKLab)
- [ ] **T056** Add unit tests for ΔE and per-channel delta calculations
- [ ] **T057** Add unit tests for tolerance application and comparison logic
- [ ] **T058** Wire unit tests into `swift test` (verify coverage)

### Phase 9b: Swift Integration & CLI

- [ ] **T059** Create Swift parity runner binary (reads corpus, invokes ColorJourney, outputs JSON)
- [ ] **T060** Implement C reference loader (reads Phase 8 artifacts)
- [ ] **T061** Build comparison bridge linking Swift output to C reference
- [ ] **T062** Implement report generator (same schema as C parity)
- [ ] **T063** Add CLI options (--corpus, --c-reference, --artifacts, --pass-gate, etc.)
- [ ] **T064** Wire Makefile target in `specs/003.5-c-algo-parity/` for building Swift runner
- [ ] **T065** Create integration tests for Swift runner (test against fixture corpus)

### Phase 9c: Execution & Validation

- [ ] **T066** Run Swift parity against default corpus, compare vs C reference
- [ ] **T067** Run Swift parity against edge cases, confirm 100% pass rate
- [ ] **T068** Verify per-case artifacts match expected deltas (should be ~0.0)
- [ ] **T069** Run unit + integration tests, confirm all passing
- [ ] **T070** Document sample run in `artifacts/swift-parity-sample/README.md`

### Phase 9d: Documentation & CI

- [ ] **T071** Update quickstart with Swift runner CLI usage
- [ ] **T072** Add Swift wrapper testing guide to documentation
- [ ] **T073** Document expected outputs and tolerance policy
- [ ] **T074** Create GitHub Actions workflow for Swift parity (this branch only)
- [ ] **T075** Integrate Swift parity into existing `.github/workflows/` (runs on 004-incremental-creation pushes)

### Phase 9e: Final Review

- [ ] **T076** Review generated reports for summary and per-case artifacts
- [ ] **T077** Analyze results and document findings in `swift-review.md`
- [ ] **T078** Verify CI integration (workflow runs on branch pushes)
- [ ] **T079** Plan follow-ups (CocoaPods, additional platforms)

---

## CI/CD Integration

### Workflow: Swift Parity (Branch-Specific)

**File**: `.github/workflows/swift-parity.yml`

**Trigger**: Pushes to `004-incremental-creation` branch only

```yaml
name: Swift Wrapper Parity
on:
  push:
    branches:
      - 004-incremental-creation
  pull_request:
    branches:
      - 004-incremental-creation

jobs:
  swift-parity:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Swift
        uses: swift-actions/setup-swift@v1
        with:
          swift-version: '5.9'
      
      - name: Run Swift parity unit tests
        run: swift test --package-path . -c release
      
      - name: Build parity runner (C core)
        run: |
          cd specs/003.5-c-algo-parity/tools/parity-runner
          make all
      
      - name: Build Swift parity runner
        run: |
          cd specs/003.5-c-algo-parity/tools/swift-parity-runner
          make build
      
      - name: Generate C reference outputs
        run: |
          cd specs/003.5-c-algo-parity/tools/parity-runner
          ./parity-runner \
            --corpus ../../corpus/default.json \
            --tolerances ../../config/tolerances.example.json \
            --artifacts ../../artifacts/ci-c-reference/ \
            --c-commit ${{ github.sha }} \
            --wasm-commit ${{ github.sha }}
      
      - name: Run Swift parity tests
        run: |
          cd specs/005-c-algo-parity/tools/swift-parity-runner
          ./swift-parity-runner \
            --corpus ../../corpus/default.json \
            --c-reference ../../artifacts/ci-c-reference/report.json \
            --artifacts ../../artifacts/ci-swift-parity/
      
      - name: Run edge cases
        run: |
          cd specs/005-c-algo-parity/tools/swift-parity-runner
          ./swift-parity-runner \
            --corpus ../../corpus/edge-cases.json \
            --c-reference ../../artifacts/ci-c-reference/report.json \
            --artifacts ../../artifacts/ci-swift-parity-edge/
      
      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: swift-parity-artifacts
          path: specs/005-c-algo-parity/artifacts/ci-swift-parity*/
      
      - name: Check pass rate
        run: |
          cd specs/005-c-algo-parity/tools/swift-parity-runner
          python3 check_pass_rate.py \
            ../../artifacts/ci-swift-parity/report.json \
            0.95
```

### Branch Restriction

CI runs **only** on:
- Pushes to `005-c-algo-parity`
- PRs targeting `005-c-algo-parity`

---

## Success Criteria

| Criterion | Target | Validation |
|-----------|--------|-----------|
| **All unit tests pass** | 100% | `swift test` exits with code 0 |
| **Integration tests pass** | 100% | Swift runner artifacts generated |
| **Parity achieved** | 100% (0 failures) | Full corpus passes with 0.0 ΔE |
| **Tolerances respected** | 95% minimum | Pass gate met on both corpus files |
| **Report schema valid** | JSON Schema | Reports match C parity format |
| **Artifacts saved** | All cases | Per-case artifacts generated |
| **CI integration complete** | Workflow runs | GitHub Actions executes on branch |
| **Documentation complete** | All guides | Quickstart, testing guide, samples |

---

## References

- [Phase 1-8 Results](../artifacts/full-run-default/report.json)
- [Corpus Definition](../corpus/schema.json)
- [Tolerance Policy](../config/README.md)
- [C Parity Results](../review.md)
- [Swift API](../../Sources/ColorJourney/ColorJourney.swift)

---

## Notes

- Swift version: 5.9+ (matches Package.swift)
- Target SDK: iOS 13+, macOS 10.15+, watchOS 6+, tvOS 13+, visionOS 1.0+
- Build flags: Match C core (-std=c99 equivalent via bridging header)
- Artifact retention: Same policy as C parity (all cases for visibility)
- Future expansion: CocoaPods validation, additional platforms once baseline established
