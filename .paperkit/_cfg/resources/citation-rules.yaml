# Citation Validation Rules
# PaperKit Reference Management
#
# These rules define validation criteria for citations and bibliography entries.
# Used by the reference-manager agent for automated checking.

style: harvard-cite-them-right
lastUpdated: 2025-12-18

# ============================================================================
# ENTRY TYPE DEFINITIONS
# ============================================================================

entryTypes:
  article:
    description: Journal article
    requiredFields:
      - author
      - title
      - journal
      - year
      - volume
    optionalFields:
      - number
      - pages
      - doi
      - url
      - note
    harvardFormat: >
      Author, A.A. (Year) 'Article title', Journal Title, Volume(Issue), pp. X-Y.

  book:
    description: Complete book
    requiredFields:
      - author # or editor
      - title
      - publisher
      - year
    optionalFields:
      - address
      - edition
      - volume
      - series
      - url
      - note
    harvardFormat: >
      Author, A.A. (Year) Title of book. Edition. Place: Publisher.

  inbook:
    description: Chapter in book (same author)
    requiredFields:
      - author
      - title
      - booktitle
      - publisher
      - year
    optionalFields:
      - chapter
      - pages
      - address
      - edition
    harvardFormat: >
      Author, A.A. (Year) 'Chapter title', in Book title. Place: Publisher, pp. X-Y.

  incollection:
    description: Chapter in edited book
    requiredFields:
      - author
      - title
      - booktitle
      - publisher
      - year
    optionalFields:
      - editor
      - pages
      - address
      - edition
      - url
      - note
    harvardFormat: >
      Author, A.A. (Year) 'Chapter title', in Editor, B.B. (ed.) Book title. Place: Publisher, pp. X-Y.

  inproceedings:
    description: Conference paper
    requiredFields:
      - author
      - title
      - booktitle
      - year
    optionalFields:
      - editor
      - pages
      - publisher
      - address
      - organization
      - url
      - note
    harvardFormat: >
      Author, A.A. (Year) 'Paper title', in Conference name, Location, Date. Place: Publisher, pp. X-Y.

  techreport:
    description: Technical report
    requiredFields:
      - author
      - title
      - institution
      - year
    optionalFields:
      - type
      - number
      - address
      - url
      - note
    harvardFormat: >
      Author, A.A. (Year) Report title. Report number. Place: Institution.

  phdthesis:
    description: PhD dissertation
    requiredFields:
      - author
      - title
      - school
      - year
    optionalFields:
      - type
      - address
      - url
      - note
    harvardFormat: >
      Author, A.A. (Year) Title. PhD thesis. University name.

  mastersthesis:
    description: Master's thesis
    requiredFields:
      - author
      - title
      - school
      - year
    optionalFields:
      - type
      - address
      - url
      - note
    harvardFormat: >
      Author, A.A. (Year) Title. Master's thesis. University name.

  misc:
    description: Miscellaneous (websites, other sources)
    requiredFields:
      - title
      - year # or use n.d.
    optionalFields:
      - author
      - url
      - howpublished
      - note
    harvardFormat: >
      Author, A.A. (Year) Title. Available at: URL (Accessed: Date).

# ============================================================================
# VALIDATION RULES
# ============================================================================

validationRules:
  # Critical errors that must be fixed
  errors:
    - id: missing-bibtex-entry
      description: Citation in text has no corresponding BibTeX entry
      severity: error
      message: "Citation '{key}' not found in bibliography database"
      fix: Add complete BibTeX entry for this citation

    - id: missing-required-field
      description: BibTeX entry missing required field for its type
      severity: error
      message: "Entry '{key}' ({type}) missing required field: {field}"
      fix: Add the missing field with complete information

    - id: missing-author
      description: Entry has no author or editor
      severity: error
      message: "Entry '{key}' has no author information"
      fix: Add author field in format "Surname, I.I."

    - id: missing-year
      description: Entry has no publication year
      severity: error
      message: "Entry '{key}' has no year"
      fix: Add year or use 'n.d.' if unknown

    - id: missing-page-for-quote
      description: Direct quote lacks page number
      severity: error
      message: "Direct quote at {location} missing page number"
      fix: Add page number to citation (Author, Year, p. X)

    - id: orphan-bibtex-entry
      description: BibTeX entry not cited anywhere in document
      severity: warning
      message: "Entry '{key}' exists but is not cited in document"
      fix: Either cite this source or remove from bibliography

  # Warnings that should be addressed
  warnings:
    - id: missing-access-date
      description: Online source without access date
      severity: warning
      message: "Online entry '{key}' missing access date"
      fix: "Add note field with Accessed: DD Month YYYY"

    - id: missing-url-for-online
      description: Online source without URL
      severity: warning
      message: "Entry '{key}' appears to be online but has no URL"
      fix: Add url field with complete URL

    - id: missing-doi
      description: Journal article without DOI when likely available
      severity: warning
      message: "Article '{key}' has no DOI"
      fix: Add doi field if available

    - id: missing-pages
      description: Article or chapter without page numbers
      severity: warning
      message: "Entry '{key}' has no page numbers"
      fix: Add pages field in format "X--Y"

    - id: missing-publisher-location
      description: Book without publisher location
      severity: warning
      message: "Book '{key}' missing publisher location"
      fix: Add address field with publisher city

    - id: inconsistent-author-format
      description: Author names not in Harvard format
      severity: warning
      message: "Entry '{key}' has non-standard author format"
      fix: Use format "Surname, I.I." or "Surname, I.I. and Surname, B.B."

  # Informational suggestions
  info:
    - id: title-capitalization
      description: Title may have incorrect capitalization
      severity: info
      message: "Entry '{key}' title may need sentence case"
      fix: Use sentence case, protect proper nouns with braces

    - id: old-source
      description: Source is more than 10 years old
      severity: info
      message: "Entry '{key}' from {year} - consider more recent sources"
      fix: Verify source is still current and relevant

    - id: duplicate-key-pattern
      description: Citation key doesn't follow naming convention
      severity: info
      message: "Entry '{key}' doesn't follow AuthorSurname_Year pattern"
      fix: Consider renaming to AuthorSurname_Year format

# ============================================================================
# FIELD FORMAT SPECIFICATIONS
# ============================================================================

fieldFormats:
  author:
    format: "Surname, I.I."
    multipleFormat: "Surname, I.I. and Surname, B.B."
    fourPlusFormat: "Surname, I.I. et al."
    examples:
      - "Smith, J."
      - "Smith, J.A."
      - "Smith, J. and Jones, P."
      - "Smith, J., Jones, P. and Brown, R."
    corporateAuthor: "Use double braces: {{Organization Name}}"

  year:
    format: "YYYY"
    noDate: "n.d."
    forthcoming: "forthcoming"
    examples:
      - "2023"
      - "n.d."

  title:
    case: sentence
    protection: "Use braces for proper nouns: {COVID-19}, {European}"
    examples:
      - "Understanding climate change impacts"
      - "A study of {COVID-19} in {European} populations"

  pages:
    singlePage: "X"
    pageRange: "X--Y"
    examples:
      - "45"
      - "123--145"

  doi:
    format: "https://doi.org/XXXXX or 10.XXXXX"
    examples:
      - "10.1002/col.20120"
      - "https://doi.org/10.1002/col.20120"

  url:
    format: "Complete URL with protocol"
    examples:
      - "https://www.example.com/article"

  accessDate:
    format: "Accessed: DD Month YYYY"
    field: note
    examples:
      - "Accessed: 15 March 2023"

# ============================================================================
# AUTO-FIX RULES
# ============================================================================

autoFixRules:
  - id: fix-author-initials
    description: Add periods after author initials
    pattern: "author = {([A-Z][a-z]+), ([A-Z])(?!\\.)}"
    replacement: "author = {$1, $2.}"
    safe: true

  - id: fix-page-range
    description: Convert single dash to double dash in page ranges
    pattern: "pages = {(\\d+)-(\\d+)}"
    replacement: "pages = {$1--$2}"
    safe: true

  - id: fix-trailing-comma
    description: Add missing trailing comma before closing brace
    pattern: "(\\w+\\s*=\\s*\\{[^}]+\\})\\s*\\}"
    replacement: "$1,\n}"
    safe: true

# ============================================================================
# REPORT TEMPLATES
# ============================================================================

reportTemplates:
  summary:
    format: |
      ## Citation Validation Report

      **Document:** {document}
      **Date:** {date}
      **Style:** Harvard (Cite Them Right)

      ### Statistics
      - Total citations: {totalCitations}
      - Unique citations: {uniqueCitations}
      - BibTeX entries: {bibEntries}
      - Match rate: {matchRate}%

      ### Status
      - ✓ Valid: {validCount}
      - ⚠️ Warnings: {warningCount}
      - ❌ Errors: {errorCount}

  errorDetail:
    format: |
      ### {severity}: {title}

      **Entry:** `{key}`
      **Issue:** {message}
      **Location:** {location}

      **Fix:** {fix}

  quickFix:
    format: |
      **Auto-fixable issue:**
      ```
      {before}
      ```
      **Suggested fix:**
      ```
      {after}
      ```

# ============================================================================
# METADATA
# ============================================================================

metadata:
  owner: core-team
  relatedFiles:
    - .paperkit/_cfg/guides/harvard-citation-guide.md
    - .paperkit/_cfg/agents/reference-manager.yaml
    - .paperkit/_cfg/workflows/validate-citations.yaml
  tags:
    - tool
    - configuration
    - citations
    - bibliography
    - harvard-style
