#!/bin/bash

# PaperKit Command Line Interface
# Version: alpha-1.0.0
# Main entry point for paperkit commands

# Get version from YAML config, fallback to VERSION file for backwards compatibility
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Get version from YAML config (get-version.sh handles VERSION file fallback if needed)
if [ -f "$SCRIPT_DIR/.paperkit/tools/get-version.sh" ]; then
    VERSION=$("$SCRIPT_DIR/.paperkit/tools/get-version.sh" 2>/dev/null || echo "unknown")
else
    VERSION="unknown"
fi

# Color codes
BLUE='\033[0;34m'
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Show version
show_version() {
    echo "paperkit version $VERSION"
}

# Version command (supports flags for update/info)
version_usage() {
    echo ""
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${NC}  ${YELLOW}PaperKit Version Management${NC}                          ${BLUE}║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}USAGE${NC}"
    echo "  paperkit version [options]"
    echo ""
    echo -e "${YELLOW}OPTIONS${NC}"
    echo -e "  ${GREEN}(no flags)${NC}             Show current version"
    echo -e "  ${GREEN}--get${NC}                  Show current version"
    echo -e "  ${GREEN}--info${NC}                 Show full version info (JSON)"
    echo -e "  ${GREEN}--set${NC} <version>        Set version (e.g., alpha-1.3.0 or 1.3.0+45)"
    echo -e "  ${GREEN}--bump${NC} <part>          Bump semver (major|minor|patch)"
    echo -e "  ${GREEN}--build${NC} <value>        Set build metadata (appends +value)"
    echo -e "  ${GREEN}--clear-build${NC}          Remove build metadata"
    echo -e "  ${GREEN}--test${NC}                 Run version system tests"
    echo ""
    echo -e "${YELLOW}EXAMPLES${NC}"
    echo -e "  ${BLUE}#${NC} Show current version"
    echo "  paperkit version"
    echo ""
    echo -e "  ${BLUE}#${NC} Bump to next patch version"
    echo "  paperkit version --bump patch"
    echo ""
    echo -e "  ${BLUE}#${NC} Set specific version with build metadata"
    echo "  paperkit version --set 1.2.3+build.456"
    echo ""
}

version_command() {
    local action=""
    local setval=""
    local bumpval=""
    local buildval=""
    local clear_build=false
    local run_tests=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --get)
                action="get"
                ;;
            --info)
                action="info"
                ;;
            --set)
                shift
                setval="${1:-}"
                ;;
            --bump)
                shift
                bumpval="${1:-}"
                ;;
            --build)
                shift
                buildval="${1:-}"
                ;;
            --clear-build)
                clear_build=true
                ;;
            --test)
                run_tests=true
                ;;
            -h|--help)
                version_usage
                return 0
                ;;
            *)
                # Ignore unknown args and continue
                ;;
        esac
        shift || break
    done

    # If no flags, just show version
    if [[ -z "$action" && -z "$setval" && -z "$bumpval" && -z "$buildval" && "$clear_build" != true && "$run_tests" != true ]]; then
        show_version
        return 0
    fi

    local VM_SCRIPT="$SCRIPT_DIR/.paperkit/tools/version-manager.py"
    local PYTHON_BIN="python3"
    if [ -x "$SCRIPT_DIR/.venv/bin/python" ]; then
        PYTHON_BIN="$SCRIPT_DIR/.venv/bin/python"
    fi

    if [ ! -f "$VM_SCRIPT" ]; then
        echo -e "${RED}Error: version-manager.py not found.${NC}"
        return 1
    fi

    # Ensure PyYAML is available for update operations
    if ! "$PYTHON_BIN" -c "import yaml" 2>/dev/null; then
        echo -e "${YELLOW}PyYAML is required for version updates.${NC}"
        echo "Install: pip install pyyaml"
        return 1
    fi

    if [[ "$action" == "get" ]]; then
        show_version
        return 0
    fi

    if [[ "$action" == "info" ]]; then
        "$PYTHON_BIN" "$VM_SCRIPT" info
        return $?
    fi

    if [[ -n "$setval" ]]; then
        "$PYTHON_BIN" "$VM_SCRIPT" set "$setval"
        return $?
    fi

    if [[ -n "$bumpval" ]]; then
        if [[ "$bumpval" != "major" && "$bumpval" != "minor" && "$bumpval" != "patch" ]]; then
            echo -e "${RED}Error: --bump must be one of major|minor|patch.${NC}"
            return 1
        fi
        "$PYTHON_BIN" "$VM_SCRIPT" bump "$bumpval"
        return $?
    fi

    if [[ -n "$buildval" ]]; then
        local cur
        cur=$("$PYTHON_BIN" "$VM_SCRIPT" get 2>/dev/null || echo "")
        if [ -z "$cur" ] || [ "$cur" = "unknown" ]; then
            cur=$("$SCRIPT_DIR/.paperkit/tools/get-version.sh" 2>/dev/null || echo "unknown")
        fi
        # Strip existing +build if present
        local base_no_build="${cur%%+*}"
        "$PYTHON_BIN" "$VM_SCRIPT" set "${base_no_build}+${buildval}"
        return $?
    fi

    if $clear_build; then
        local cur
        cur=$("$PYTHON_BIN" "$VM_SCRIPT" get 2>/dev/null || echo "")
        if [ -z "$cur" ] || [ "$cur" = "unknown" ]; then
            cur=$("$SCRIPT_DIR/.paperkit/tools/get-version.sh" 2>/dev/null || echo "unknown")
        fi
        local base_no_build="${cur%%+*}"
        "$PYTHON_BIN" "$VM_SCRIPT" set "${base_no_build}"
        return $?
    fi

    if $run_tests; then
        PATH="$SCRIPT_DIR/.venv/bin:$PATH" "$SCRIPT_DIR/.paperkit/tools/test-version-system.sh"
        return $?
    fi

    # Fallback
    show_version
}

# Show help
show_help() {
    echo ""
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${NC}  ${YELLOW}PaperKit${NC} - Research Paper Assistant Kit              ${BLUE}║${NC}"
    echo -e "${BLUE}║${NC}  Version: $VERSION                                     ${BLUE}║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}USAGE${NC}"
    echo "  paperkit <command> [options]"
    echo ""
    echo -e "${YELLOW}COMMANDS${NC}"
    echo -e "  ${GREEN}init${NC}                 Initialize a new paperkit project"
    echo -e "  ${GREEN}generate${NC} [--target]  Generate IDE files from .paperkit/ source"
    echo -e "  ${GREEN}validate${NC}             Validate agent/workflow/tool schemas"
    echo -e "  ${GREEN}version${NC}              Version management (show, set, bump)"
    echo -e "  ${GREEN}latex${NC}                LaTeX tools (build, lint, open)"
    echo -e "  ${GREEN}evidence${NC}             Extract evidence from PDFs"
    echo -e "  ${GREEN}help${NC}                 Show this help message"
    echo ""
    echo -e "${YELLOW}GENERATE OPTIONS${NC}"
    echo "  --target=copilot     GitHub Copilot agents only"
    echo "  --target=codex       OpenAI Codex prompts only"
    echo "  --target=all         All IDEs (default)"
    echo "  --check              Check if files need updating"
    echo ""
    echo -e "${YELLOW}VERSION COMMANDS${NC}"
    echo "  paperkit version                  Show current version"
    echo "  paperkit version --info           Show full version info (JSON)"
    echo "  paperkit version --set <version>  Set version (e.g., alpha-1.3.0)"
    echo "  paperkit version --bump <part>    Bump version (major|minor|patch)"
    echo "  paperkit version --build <value>  Add build metadata (+value)"
    echo "  paperkit version --clear-build    Remove build metadata"
    echo "  paperkit version --test           Run version system tests"
    echo ""
    echo -e "${YELLOW}LATEX COMMANDS${NC}"
    echo "  paperkit latex build              Compile LaTeX document to PDF"
    echo "  paperkit latex lint               Check LaTeX syntax"
    echo "  paperkit latex open               Open built PDF in viewer"
    echo ""
    echo -e "${YELLOW}EVIDENCE COMMANDS${NC}"
    echo "  paperkit evidence extract <pdf_dir> <out.md> [terms...]"
    echo "                                    Extract quotes from PDFs"
    echo ""
    echo -e "${YELLOW}EXAMPLES${NC}"
    echo -e "  ${BLUE}#${NC} Initialize a new project"
    echo "  paperkit init"
    echo ""
    echo -e "  ${BLUE}#${NC} Regenerate IDE files"
    echo "  paperkit generate"
    echo "  paperkit generate --target=copilot"
    echo ""
    echo -e "  ${BLUE}#${NC} Manage versions"
    echo "  paperkit version --bump patch"
    echo "  paperkit version --build 45"
    echo ""
    echo -e "  ${BLUE}#${NC} Build documentation"
    echo "  paperkit latex build"
    echo "  paperkit latex open"
    echo ""
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "For more information: ${GREEN}.paperkit/docs/${NC}"
    echo ""
}

# Initialize project
init_project() {
    echo -e "${BLUE}Initializing PaperKit in current directory...${NC}"
    
    # Check if already initialized
    if [ -f "VERSION" ] && [ -d ".paper" ]; then
        echo -e "${YELLOW}⚠ PaperKit appears to already be initialized here.${NC}"
        read -p "Reinitialize? (yes/no): " confirm
        if [[ ! "$confirm" =~ ^[Yy][Ee][Ss]$ ]]; then
            echo "Cancelled."
            exit 0
        fi
    fi
    
    # Run the installer (prefer v2 if available)
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    if [ -f "$SCRIPT_DIR/paperkit-install-v2.sh" ]; then
        "$SCRIPT_DIR/paperkit-install-v2.sh"
    elif [ -f "$SCRIPT_DIR/paperkit-install.sh" ]; then
        "$SCRIPT_DIR/paperkit-install.sh"
    else
        echo -e "${RED}Error: paperkit installer not found.${NC}"
        echo "Make sure you have the complete paperkit distribution."
        exit 1
    fi
}

# Generate IDE files
generate_ide_files() {
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    
    if [ -f "$SCRIPT_DIR/paperkit-generate.sh" ]; then
        "$SCRIPT_DIR/paperkit-generate.sh" "$@"
    else
        echo -e "${RED}Error: paperkit-generate.sh not found.${NC}"
        exit 1
    fi
}

# LaTeX commands
latex_usage() {
    echo ""
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${NC}  ${YELLOW}PaperKit LaTeX Tools${NC}                                  ${BLUE}║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}USAGE${NC}"
    echo "  paperkit latex <command>"
    echo ""
    echo -e "${YELLOW}COMMANDS${NC}"
    echo -e "  ${GREEN}build${NC}    Compile LaTeX document to PDF"
    echo -e "  ${GREEN}lint${NC}     Check LaTeX syntax and structure"
    echo -e "  ${GREEN}open${NC}     Open built PDF in default viewer"
    echo ""
    echo -e "${YELLOW}EXAMPLES${NC}"
    echo -e "  ${BLUE}#${NC} Build and open PDF"
    echo "  paperkit latex build"
    echo "  paperkit latex open"
    echo ""
}

latex_command() {
    local subcmd="${1:-}"
    case "$subcmd" in
        build)
            if [ -f "$SCRIPT_DIR/.paperkit/tools/build-latex.sh" ]; then
                "$SCRIPT_DIR/.paperkit/tools/build-latex.sh"
            else
                echo -e "${RED}Error: build-latex.sh not found.${NC}"
                return 1
            fi
            ;;
        lint)
            if [ -f "$SCRIPT_DIR/.paperkit/tools/lint-latex.sh" ]; then
                "$SCRIPT_DIR/.paperkit/tools/lint-latex.sh"
            else
                echo -e "${RED}Error: lint-latex.sh not found.${NC}"
                return 1
            fi
            ;;
        open)
            # Try common output locations for PDF
            local candidates=(
                "$SCRIPT_DIR/open-agents/output-final/pdf/main.pdf"
                "$SCRIPT_DIR/.paperkit/data/output-final/pdf/main.pdf"
                "$SCRIPT_DIR/latex/main.pdf"
            )
            local pdf=""
            for f in "${candidates[@]}"; do
                if [ -f "$f" ]; then
                    pdf="$f"
                    break
                fi
            done
            if [ -z "$pdf" ]; then
                echo -e "${YELLOW}No PDF found. Run:${NC} paperkit latex build"
                return 1
            fi
            if command -v open >/dev/null 2>&1; then
                open "$pdf"
            else
                echo "$pdf"
            fi
            ;;
        -h|--help|*)
            latex_usage
            ;;
    esac
}

# Evidence extraction commands
evidence_usage() {
    echo ""
    echo -e "${BLUE}╔══════════════════════════════════════════════════════════════╗${NC}"
    echo -e "${BLUE}║${NC}  ${YELLOW}PaperKit Evidence Extraction${NC}                         ${BLUE}║${NC}"
    echo -e "${BLUE}╚══════════════════════════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "${YELLOW}USAGE${NC}"
    echo "  paperkit evidence extract <pdf_dir> <output.md> [terms...]"
    echo ""
    echo -e "${YELLOW}ARGUMENTS${NC}"
    echo -e "  ${GREEN}<pdf_dir>${NC}     Directory containing PDF files"
    echo -e "  ${GREEN}<output.md>${NC}   Output markdown file"
    echo -e "  ${GREEN}[terms...]${NC}    Optional search terms to filter"
    echo ""
    echo -e "${YELLOW}DESCRIPTION${NC}"
    echo "  Extract text evidence from PDF files based on search terms."
    echo "  Useful for forensic audits and citation verification."
    echo ""
    echo -e "${YELLOW}EXAMPLES${NC}"
    echo -e "  ${BLUE}#${NC} Extract all text from PDFs"
    echo "  paperkit evidence extract ./pdfs/ evidence.md"
    echo ""
    echo -e "  ${BLUE}#${NC} Extract text containing specific terms"
    echo "  paperkit evidence extract ./pdfs/ quotes.md \"color theory\" \"perception\""
    echo ""
}

evidence_command() {
    local subcmd="${1:-}"
    shift || true
    case "$subcmd" in
        extract)
            local pdf_dir="${1:-}"
            local output_md="${2:-}"
            shift 2 || true
            if [ -z "$pdf_dir" ] || [ -z "$output_md" ]; then
                echo -e "${YELLOW}Usage:${NC} paperkit evidence extract <pdf_dir> <output_md> [terms...]"
                return 1
            fi
            if [ -f "$SCRIPT_DIR/.paperkit/tools/extract-evidence.sh" ]; then
                "$SCRIPT_DIR/.paperkit/tools/extract-evidence.sh" "$pdf_dir" "$output_md" "$@"
            else
                echo -e "${RED}Error: extract-evidence.sh not found.${NC}"
                return 1
            fi
            ;;
        -h|--help|*)
            evidence_usage
            ;;
    esac
}

# Validate schemas
validate_schemas() {
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    
    # Check .paper directory exists
    if [ ! -d ".paper" ]; then
        echo -e "${YELLOW}⚠ .paperkit/ directory not found. Run 'paperkit init' first.${NC}"
        exit 1
    fi
    
    # Prefer Python validator if available and dependencies are met
    if [ -f "$SCRIPT_DIR/paperkit-validate.py" ]; then
        # Check if required Python packages are available
        if python3 -c "import yaml, jsonschema" 2>/dev/null; then
            python3 "$SCRIPT_DIR/paperkit-validate.py" "$@"
            return $?
        else
            echo -e "${YELLOW}Note: Install 'pyyaml' and 'jsonschema' for full schema validation:${NC}"
            echo "  pip install pyyaml jsonschema"
            echo ""
        fi
    fi
    
    # Fallback to basic validation
    echo -e "${BLUE}Validating PaperKit schemas (basic mode)...${NC}"
    local has_errors=false
    
    # Check for validation tools (prefer .paperkit/tools/, fall back to legacy)
    local validate_script=""
    if [ -f "$SCRIPT_DIR/.paperkit/tools/validate-structure.py" ]; then
        validate_script="$SCRIPT_DIR/.paperkit/tools/validate-structure.py"
    elif [ -f "$SCRIPT_DIR/open-agents/tools/validate-structure.py" ]; then
        validate_script="$SCRIPT_DIR/open-agents/tools/validate-structure.py"
    fi
    
    if [ -n "$validate_script" ] && python3 -c "import yaml" 2>/dev/null; then
        echo "Running structure validation..."
        python3 "$validate_script" || has_errors=true
    fi
    
    # Basic checks
    echo "Checking agent definitions..."
    local agent_count=0
    for f in .paperkit/core/agents/*.md .paperkit/specialist/agents/*.md; do
        [ -f "$f" ] && ((agent_count++))
    done
    echo -e "${GREEN}✓ Found $agent_count agent definitions${NC}"
    
    echo "Checking manifests..."
    for manifest in .paperkit/_cfg/agent-manifest.yaml .paperkit/_cfg/workflow-manifest.yaml .paperkit/_cfg/tool-manifest.yaml; do
        if [ -f "$manifest" ]; then
            echo -e "${GREEN}✓ $(basename $manifest) exists${NC}"
        else
            echo -e "${YELLOW}⚠ $(basename $manifest) missing${NC}"
        fi
    done
    
    if $has_errors; then
        echo -e "${RED}Validation completed with errors.${NC}"
        exit 1
    else
        echo -e "${GREEN}✓ Basic validation complete${NC}"
        echo -e "${YELLOW}Install 'pyyaml' and 'jsonschema' for full JSON schema validation.${NC}"
    fi
}

# Main command dispatcher
case "${1:-help}" in
    init)
        init_project
        ;;
    generate)
        shift
        generate_ide_files "$@"
        ;;
    validate)
        validate_schemas
        ;;
    latex)
        shift
        latex_command "$@"
        ;;
    evidence)
        shift
        evidence_command "$@"
        ;;
    version|--version|-v)
        shift
        version_command "$@"
        ;;
    help|--help|-h|"")
        show_help
        ;;
    *)
        echo -e "${RED}Error: Unknown command '$1'${NC}"
        echo ""
        show_help
        exit 1
        ;;
esac
